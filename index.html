<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <!-- [C√≥digo del head se mantiene igual hasta el body] -->
</head>
<body>
    <!-- Pantalla de carga -->
    <div id="loading-screen">
        <div class="loading-logo">üí∞</div>
        <h1 style="font-weight: 600; font-size: 1.5rem; margin-bottom: 8px;">Commission Manager Pro</h1>
        <p id="loading-message" style="opacity: 0.9; font-size: 0.9rem;">Inicializando aplicaci√≥n...</p>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>
    
    <!-- Contenedor principal -->
    <div id="app" style="display: none;"></div>
    
    <!-- Scripts modulares -->
    <script type="module">
        import { localDB } from './db.js';
        import { supabaseManager } from './supabase.js';
        import { syncManager } from './sync.js';
        import { empresasManager } from './empresas.js'; // NUEVO
        import { contratosManager } from './contratos.js';
        import { certificacionesManager } from './certificaciones.js';
        import { pagosManager } from './pagos.js';
        import { reportesManager } from './reportes.js';
        
        // App principal
        class CommissionManagerApp {
            constructor() {
                this.currentUser = null;
                this.currentView = 'login';
                this.isInitialized = false;
                this.currentEmpresa = null;
                this.currentContrato = null;
            }
            
            async init() {
                console.log('üöÄ Commission Manager Pro - Inicializando');
                
                try {
                    // Actualizar mensaje
                    this.updateLoadingMessage('Configurando almacenamiento...');
                    
                    // Inicializar IndexedDB
                    await localDB.init();
                    
                    // Verificar integridad
                    await localDB.checkIntegrity();
                    
                    // CORRECCI√ìN: Inicializar empresasManager
                    if (window.empresasManager) {
                        console.log('üîß Inicializando Empresas Manager');
                    }
                    
                    // Actualizar mensaje
                    this.updateLoadingMessage('Verificando autenticaci√≥n...');
                    
                    // Restaurar sesi√≥n si existe
                    const session = await supabaseManager.restoreSession();
                    
                    if (session && supabaseManager.user?.email_confirmed_at) {
                        this.currentUser = supabaseManager.user;
                        // CORRECCI√ìN: Configurar user en empresasManager
                        if (empresasManager && empresasManager.setCurrentUser) {
                            empresasManager.setCurrentUser(this.currentUser);
                        }
                        await this.loadDashboard();
                    } else {
                        await this.loadLogin();
                    }
                    
                    this.isInitialized = true;
                    console.log('‚úÖ Aplicaci√≥n inicializada');
                    
                } catch (error) {
                    console.error('‚ùå Error inicializando aplicaci√≥n:', error);
                    await this.showError('Error al inicializar: ' + error.message);
                } finally {
                    // Ocultar pantalla de carga despu√©s de 1 segundo
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen) {
                            loadingScreen.style.opacity = '0';
                            setTimeout(() => {
                                loadingScreen.style.display = 'none';
                            }, 300);
                        }
                        
                        const app = document.getElementById('app');
                        if (app) {
                            app.style.display = 'block';
                        }
                    }, 1000);
                }
            }
            
            updateLoadingMessage(message) {
                const element = document.getElementById('loading-message');
                if (element) {
                    element.textContent = message;
                }
            }
            
            async loadLogin() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                        <div style="width: 100%; max-width: 400px;">
                            <div style="text-align: center; margin-bottom: 40px;">
                                <div style="font-size: 3rem; margin-bottom: 16px;">üí∞</div>
                                <h1 style="font-size: 1.75rem; font-weight: 700; color: white; margin-bottom: 8px;">Commission Manager</h1>
                                <p style="color: rgba(255,255,255,0.9); font-size: 0.95rem;">Gesti√≥n profesional de comisiones</p>
                            </div>
                            
                            <div style="background: white; border-radius: 16px; padding: 32px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                                <!-- CORRECCI√ìN: Formulario de login con formulario v√°lido -->
                                <form id="login-form-element" onsubmit="return false;">
                                    <div id="login-form">
                                        <div style="margin-bottom: 20px;">
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 8px;">Email</label>
                                            <div style="position: relative;">
                                                <div class="icon-wrapper" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">
                                                    <div class="icon icon-user icon-sm"></div>
                                                </div>
                                                <input type="email" id="email" name="email" placeholder="tu@email.com" required style="width: 100%; padding: 12px 12px 12px 48px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;">
                                            </div>
                                        </div>
                                        
                                        <div style="margin-bottom: 24px;">
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 8px;">Contrase√±a</label>
                                            <div style="position: relative;">
                                                <div class="icon-wrapper" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">
                                                    <div class="icon icon-lock icon-sm"></div>
                                                </div>
                                                <input type="password" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required style="width: 100%; padding: 12px 12px 12px 48px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;">
                                            </div>
                                        </div>
                                        
                                        <button type="submit" id="login-btn" style="width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: background 0.2s;">
                                            Iniciar Sesi√≥n
                                        </button>
                                    </div>
                                </form>
                                
                                <div style="text-align: center; margin-top: 24px;">
                                    <a href="#" id="register-link" style="font-size: 0.875rem; color: #3b82f6; text-decoration: none; font-weight: 500;">
                                        ¬øNo tienes cuenta? Reg√≠strate
                                    </a>
                                    <div style="margin-top: 16px;">
                                        <a href="#" id="forgot-password" style="font-size: 0.875rem; color: #64748b; text-decoration: none;">
                                            ¬øOlvidaste tu contrase√±a?
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- CORRECCI√ìN: Formulario de registro con formulario v√°lido -->
                                <div id="register-form" style="display: none;">
                                    <form id="register-form-element" onsubmit="return false;">
                                        <div style="margin-bottom: 16px;">
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 8px;">Nombre completo</label>
                                            <input type="text" id="reg-name" name="reg-name" placeholder="Tu nombre" required style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                                        </div>
                                        
                                        <div style="margin-bottom: 16px;">
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 8px;">Email</label>
                                            <input type="email" id="reg-email" name="reg-email" placeholder="tu@email.com" required style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                                        </div>
                                        
                                        <div style="margin-bottom: 16px;">
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 8px;">Contrase√±a</label>
                                            <input type="password" id="reg-password" name="reg-password" placeholder="M√≠nimo 6 caracteres" minlength="6" required style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                                        </div>
                                        
                                        <div style="margin-bottom: 24px;">
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 8px;">Confirmar contrase√±a</label>
                                            <input type="password" id="reg-confirm" name="reg-confirm" placeholder="Repite tu contrase√±a" minlength="6" required style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                                        </div>
                                        
                                        <button type="submit" id="register-btn" style="width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 500; cursor: pointer;">
                                            Crear Cuenta
                                        </button>
                                    </form>
                                    
                                    <div style="text-align: center; margin-top: 24px;">
                                        <a href="#" id="back-to-login" style="font-size: 0.875rem; color: #3b82f6; text-decoration: none; font-weight: 500;">
                                            Volver a inicio de sesi√≥n
                                        </a>
                                    </div>
                                </div>

                                <!-- CORRECCI√ìN: Formulario de recuperaci√≥n con formulario v√°lido -->
                                <div id="reset-password-form" style="display: none;">
                                    <form id="reset-form-element" onsubmit="return false;">
                                        <div style="margin-bottom: 24px;">
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 8px;">Email</label>
                                            <div style="position: relative;">
                                                <div class="icon-wrapper" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">
                                                    <div class="icon icon-mail icon-sm"></div>
                                                </div>
                                                <input type="email" id="reset-email" name="reset-email" placeholder="tu@email.com" required style="width: 100%; padding: 12px 12px 12px 48px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                                            </div>
                                        </div>
                                        
                                        <button type="submit" id="reset-btn" style="width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 500; cursor: pointer;">
                                            Enviar instrucciones
                                        </button>
                                    </form>
                                    
                                    <div style="text-align: center; margin-top: 24px;">
                                        <a href="#" id="back-to-login-from-reset" style="font-size: 0.875rem; color: #3b82f6; text-decoration: none; font-weight: 500;">
                                            Volver a inicio de sesi√≥n
                                        </a>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #f1f5f9;">
                                    <p style="text-align: center; font-size: 0.75rem; color: #94a3b8;">
                                        <span style="display: inline-flex; align-items: center; gap: 4px;">
                                            <div class="icon-wrapper" style="width: 24px; height: 24px;">
                                                <div class="icon icon-sync icon-sm"></div>
                                            </div>
                                            Sincronizaci√≥n autom√°tica
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                this.setupLoginListeners();
            }
            
            setupLoginListeners() {
                // Login form submit
                document.getElementById('login-form-element')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleLogin();
                });
                
                // Register form submit
                document.getElementById('register-form-element')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleRegister();
                });
                
                // Reset password form submit
                document.getElementById('reset-form-element')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleResetPassword();
                });
                
                // Enter en campos de login
                document.getElementById('password')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.handleLogin();
                    }
                });
                
                // Alternar formularios
                document.getElementById('register-link')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('register-form').style.display = 'block';
                    document.getElementById('reset-password-form').style.display = 'none';
                });
                
                document.getElementById('back-to-login')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('register-form').style.display = 'none';
                    document.getElementById('login-form').style.display = 'block';
                    document.getElementById('reset-password-form').style.display = 'none';
                });
                
                document.getElementById('forgot-password')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('register-form').style.display = 'none';
                    document.getElementById('reset-password-form').style.display = 'block';
                });
                
                document.getElementById('back-to-login-from-reset')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('reset-password-form').style.display = 'none';
                    document.getElementById('login-form').style.display = 'block';
                    document.getElementById('register-form').style.display = 'none';
                });
            }
            
            async handleLogin() {
                const email = document.getElementById('email')?.value;
                const password = document.getElementById('password')?.value;
                const btn = document.getElementById('login-btn');
                
                if (!email || !password) {
                    this.showToast('Por favor, completa todos los campos', 'warning');
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = 'Iniciando...';
                
                try {
                    const result = await supabaseManager.login(email, password);
                    
                    if (result.success) {
                        this.currentUser = result.user;
                        // CORRECCI√ìN: Configurar user en empresasManager
                        if (empresasManager && empresasManager.setCurrentUser) {
                            empresasManager.setCurrentUser(this.currentUser);
                        }
                        await this.loadDashboard();
                        this.showToast('¬°Bienvenido!', 'success');
                    } else {
                        this.showToast(result.error, 'error');
                        btn.disabled = false;
                        btn.textContent = 'Iniciar Sesi√≥n';
                    }
                } catch (error) {
                    this.showToast('Error al iniciar sesi√≥n', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Iniciar Sesi√≥n';
                }
            }
            
            async handleRegister() {
                const name = document.getElementById('reg-name')?.value;
                const email = document.getElementById('reg-email')?.value;
                const password = document.getElementById('reg-password')?.value;
                const confirm = document.getElementById('reg-confirm')?.value;
                const btn = document.getElementById('register-btn');
                
                if (!name || !email || !password || !confirm) {
                    this.showToast('Por favor, completa todos los campos', 'warning');
                    return;
                }
                
                if (password !== confirm) {
                    this.showToast('Las contrase√±as no coinciden', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    this.showToast('La contrase√±a debe tener al menos 6 caracteres', 'error');
                    return;
                }
                
                // Validar formato de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    this.showToast('Por favor ingresa un email v√°lido', 'error');
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = 'Creando cuenta...';
                
                try {
                    const result = await supabaseManager.register(email, password, {
                        nombre: name,
                        nombre_usuario: email.split('@')[0]
                    });
                    
                    if (result.success) {
                        if (result.needsEmailVerification) {
                            // Mostrar mensaje de confirmaci√≥n
                            this.showEmailConfirmationMessage(email, name);
                            
                            // Volver al formulario de login despu√©s de 5 segundos
                            setTimeout(() => {
                                document.getElementById('register-form').style.display = 'none';
                                document.getElementById('login-form').style.display = 'block';
                                
                                // Limpiar formularios
                                document.getElementById('reg-name').value = '';
                                document.getElementById('reg-email').value = '';
                                document.getElementById('reg-password').value = '';
                                document.getElementById('reg-confirm').value = '';
                                
                                // Poner el email en el campo de login
                                document.getElementById('email').value = email;
                                
                                btn.disabled = false;
                                btn.textContent = 'Crear Cuenta';
                            }, 5000);
                            
                            return;
                        }
                        
                        this.currentUser = result.user;
                        // CORRECCI√ìN: Configurar user en empresasManager
                        if (empresasManager && empresasManager.setCurrentUser) {
                            empresasManager.setCurrentUser(this.currentUser);
                        }
                        await this.loadDashboard();
                        this.showToast('¬°Cuenta creada exitosamente!', 'success');
                    } else {
                        this.showToast(result.error || result.message || 'Error al crear cuenta', 'error');
                        btn.disabled = false;
                        btn.textContent = 'Crear Cuenta';
                    }
                } catch (error) {
                    this.showToast('Error al crear cuenta', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Crear Cuenta';
                }
            }

            async handleResetPassword() {
                const email = document.getElementById('reset-email')?.value;
                const btn = document.getElementById('reset-btn');
                
                if (!email) {
                    this.showToast('Por favor ingresa tu email', 'warning');
                    return;
                }
                
                // Validar formato de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    this.showToast('Por favor ingresa un email v√°lido', 'error');
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = 'Enviando...';
                
                try {
                    const result = await supabaseManager.resetPassword(email);
                    
                    if (result.success) {
                        this.showToast(result.message, 'success');
                        // Volver al login despu√©s de 3 segundos
                        setTimeout(() => {
                            document.getElementById('reset-password-form').style.display = 'none';
                            document.getElementById('login-form').style.display = 'block';
                            document.getElementById('reset-email').value = '';
                            btn.disabled = false;
                            btn.textContent = 'Enviar instrucciones';
                        }, 3000);
                    } else {
                        this.showToast(result.error, 'error');
                        btn.disabled = false;
                        btn.textContent = 'Enviar instrucciones';
                    }
                } catch (error) {
                    this.showToast('Error al enviar instrucciones', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Enviar instrucciones';
                }
            }
            
            // [El resto del c√≥digo se mantiene igual...]
            
            // CORRECCI√ìN: M√©todo para crear empresas usando empresasManager
            async saveNewCompany(modal) {
                const saveBtn = modal.querySelector('.modal-save-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Guardando...';
                
                // Obtener valores del formulario
                const companyData = {
                    nombre: modal.querySelector('#company-name').value.trim(),
                    director: modal.querySelector('#company-director').value.trim(),
                    comision_default: parseFloat(modal.querySelector('#company-comision').value) || 1.00,
                    descripcion: modal.querySelector('#company-descripcion').value.trim(),
                    estado: modal.querySelector('input[name="company-estado"]:checked').value
                };
                
                // Validar campos requeridos
                if (!companyData.nombre) {
                    this.showToast('El nombre de la empresa es requerido', 'error');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Guardar Empresa';
                    return;
                }
                
                try {
                    // Usar empresasManager para crear la empresa
                    if (empresasManager && empresasManager.createEmpresa) {
                        const result = await empresasManager.createEmpresa(companyData);
                        
                        if (result.success) {
                            this.showToast('Empresa creada correctamente', 'success');
                            modal.remove();
                            
                            // Intentar sincronizar con Supabase
                            try {
                                const syncResult = await syncManager.sync();
                                if (syncResult.success) {
                                    this.showToast('Empresa sincronizada con el servidor', 'success');
                                }
                            } catch (syncError) {
                                console.log('Empresa guardada localmente, se sincronizar√° m√°s tarde');
                            }
                            
                            await this.loadCompaniesList();
                        } else {
                            this.showToast(result.error || 'Error al crear empresa', 'error');
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Guardar Empresa';
                        }
                    } else {
                        throw new Error('EmpresasManager no disponible');
                    }
                } catch (error) {
                    console.error('Error al crear empresa:', error);
                    this.showToast('Error al crear empresa: ' + error.message, 'error');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Guardar Empresa';
                }
            }
            
            async loadCompaniesList() {
                const container = document.getElementById('companies-list');
                if (!container) return;
                
                try {
                    // Usar empresasManager para obtener empresas
                    let empresas = [];
                    if (empresasManager && empresasManager.getAllEmpresas) {
                        empresas = await empresasManager.getAllEmpresas();
                    } else {
                        // Fallback al m√©todo anterior
                        empresas = await this.getEmpresas();
                    }
                    
                    if (empresas.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 48px; background: white; border-radius: 12px;">
                                <div style="font-size: 3rem; margin-bottom: 16px;">üè¢</div>
                                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 8px;">No hay empresas</h3>
                                <p style="color: #64748b; margin-bottom: 24px;">Comienza agregando tu primera empresa</p>
                                <button id="add-first-company" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer;">
                                    Agregar Empresa
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('add-first-company')?.addEventListener('click', () => {
                            this.showNewCompanyModal();
                        });
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Director</th>
                                        <th>Comisi√≥n</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${empresas.map(empresa => `
                                        <tr>
                                            <td>
                                                <strong>${empresa.nombre}</strong>
                                                ${empresa.descripcion ? `<br><small style="color: #64748b;">${empresa.descripcion.substring(0, 50)}${empresa.descripcion.length > 50 ? '...' : ''}</small>` : ''}
                                            </td>
                                            <td>${empresa.director || '-'}</td>
                                            <td>${empresa.comision_default || 1}%</td>
                                            <td>
                                                <span style="background: ${empresa.estado === 'activa' ? '#dcfce7' : '#f1f5f9'}; color: ${empresa.estado === 'activa' ? '#166534' : '#64748b'}; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500;">
                                                    ${empresa.estado === 'activa' ? 'Activa' : 'Inactiva'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="edit-company" data-id="${empresa.id}" style="background: #f1f5f9; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.875rem; cursor: pointer; margin-right: 8px;">Editar</button>
                                                <button class="delete-company" data-id="${empresa.id}" style="background: #fee2e2; color: #dc2626; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Eliminar</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // Agregar listeners
                    container.querySelectorAll('.edit-company').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = e.target.dataset.id;
                            this.showEditCompanyModal(id);
                        });
                    });
                    
                    container.querySelectorAll('.delete-company').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = e.target.dataset.id;
                            this.deleteCompany(id);
                        });
                    });
                    
                } catch (error) {
                    console.error('Error cargando empresas:', error);
                    container.innerHTML = '<p style="color: #ef4444;">Error al cargar empresas</p>';
                }
            }
            
            async getEmpresas() {
                try {
                    // Usar empresasManager si est√° disponible
                    if (empresasManager && empresasManager.getAllEmpresas) {
                        return await empresasManager.getAllEmpresas();
                    }
                    // Fallback al m√©todo anterior
                    return await localDB.getAll('empresas');
                } catch (error) {
                    console.error('Error obteniendo empresas:', error);
                    return [];
                }
            }
            
            // [El resto del c√≥digo se mantiene igual...]
        }
        
        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            window.app = new CommissionManagerApp();
            await window.app.init();
        });
        
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado con √©xito:', registration.scope);
                        
                        // Verificar si hay una nueva versi√≥n del Service Worker
                        if (registration.waiting) {
                            console.log('üîÑ Nueva versi√≥n del Service Worker disponible');
                        }
                        
                        // Escuchar actualizaciones
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('üîÑ Service Worker update found:', newWorker?.state);
                            
                            newWorker?.addEventListener('statechange', () => {
                                console.log('üîÑ Service Worker state changed:', newWorker.state);
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üîÑ Nueva versi√≥n lista para activar');
                                    // Podr√≠as mostrar un mensaje al usuario aqu√≠
                                }
                            });
                        });
                    })
                    .catch(err => console.log('‚ùå Service Worker no registrado:', err));
            });
        }
    </script>
</body>
</html>
